#!/bin/bash
# –≠—Ç–æ—Ç —Ñ–ª–∞–≥ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–∫—Ä–∏–ø—Ç, –µ—Å–ª–∏ –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π
set -e

# --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ ---
VENV_DIR=".venv"
AES_CONFIG_FILE="config_light.py"
MAIN_PYTHON_FILE="server.py"

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∫—Ä–∞—Å–∏–≤—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ---
print_header() {
    echo ""
    echo "================================================================="
    echo " $1"
    echo "================================================================="
    sleep 1
}

# --- –®–ê–ì 1: –ù–ê–°–¢–†–û–ô–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø ---
print_header "‚öôÔ∏è  –®–ê–ì 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -d "$VENV_DIR" ]; then
    echo "üêç –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python –≤ '$VENV_DIR'..."
    python3 -m venv "$VENV_DIR"
fi

# –°–æ–∑–¥–∞–µ–º requirements.txt –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
echo "üìù –°–æ–∑–¥–∞—é requirements.txt..."
cat << EOF > requirements.txt
aiohttp
pycryptodome
websockets
EOF

echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt..."
# –Ø–í–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ–º pip –∏–∑ –Ω–∞—à–µ–≥–æ venv –∏ –ü–û–ö–ê–ó–´–í–ê–ï–ú –≤—ã–≤–æ–¥
"$VENV_DIR/bin/pip" install -r requirements.txt
echo "‚úÖ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é npm-–ø–∞–∫–µ—Ç '@vkontakte/vk-tunnel'..."
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ, –∫–∞–∫ –∏ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å
npm i -g @vkontakte/vk-tunnel
echo "‚úÖ npm-–ø–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

# --- –®–ê–ì 2: –ù–ê–°–¢–†–û–ô–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–• –§–ê–ô–õ–û–í ---
print_header "‚úçÔ∏è  –®–ê–ì 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ config_light.py
if [ ! -f "$AES_CONFIG_FILE" ]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª '$AES_CONFIG_FILE' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É AES –∫–ª—é—á–∞."
else
    echo "üîë –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—ã–π AES –∫–ª—é—á..."
    AES_KEY=$(openssl rand -hex 16)
    # –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π sed, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–º–µ–Ω–∏—Ç –∫–ª—é—á, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    sed -i.bak "s/\"aes_key_hex\": \".*\"/\"aes_key_hex\": \"$AES_KEY\"/" "$AES_CONFIG_FILE"
    echo "‚úÖ –ù–æ–≤—ã–π AES –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω –≤ $AES_CONFIG_FILE."
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ server.py
if [ ! -f "$MAIN_PYTHON_FILE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª '$MAIN_PYTHON_FILE' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ –º–æ–≥—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å."
    exit 1
fi

echo ""
echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Telegram:"
read -p "   - Telegram BOT_TOKEN: " BOT_TOKEN
read -p "   - Telegram CHAT_ID (–¥–ª—è –≥—Ä—É–ø–ø/–∫–∞–Ω–∞–ª–æ–≤ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å -100): " CHAT_ID
read -p "   - –í–∞—à –ª–∏—á–Ω—ã–π Telegram User ID (–¥–ª—è –∫–æ–º–∞–Ω–¥—ã /restart-tunnel): " ALLOWED_USER_ID

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã sed –¥–ª—è –∑–∞–º–µ–Ω—ã
sed -i.bak \
    -e "s/BOT_TOKEN = \".*\"/BOT_TOKEN = \"$BOT_TOKEN\"/" \
    -e "s/CHAT_ID = \".*\"/CHAT_ID = \"$CHAT_ID\"/" \
    -e "s/ALLOWED_USER_ID = .*/ALLOWED_USER_ID = $ALLOWED_USER_ID/" \
    "$MAIN_PYTHON_FILE"

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ '$MAIN_PYTHON_FILE'."


# --- –®–ê–ì 3: –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
print_header "üöÄ –®–ê–ì 3: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
read -p "–•–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å VK-TUNNEL —Å–µ–π—á–∞—Å –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ? (y/n) " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "‚è≥ –ó–∞–ø—É—Å–∫–∞—é server.py —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã..."
    sleep 3

    # –Ø–í–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ–º python3 –∏–∑ –Ω–∞—à–µ–≥–æ venv
    nohup "$VENV_DIR/bin/python3" "$MAIN_PYTHON_FILE" > server.log 2>&1 &
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º PID, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    if ps -p $! > /dev/null; then
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å '$MAIN_PYTHON_FILE' —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ."
        echo "   - –õ–æ–≥–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–∞–Ω–¥–æ–π: tail -f server.log"
        echo "   - –ß—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –Ω–∞–π–¥–∏—Ç–µ PID –∫–æ–º–∞–Ω–¥–æ–π 'pgrep -f server.py' –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ 'kill <PID>'"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ '$MAIN_PYTHON_FILE'. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ 'server.log' –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫."
    fi
else
    echo "‚ÑπÔ∏è  –ó–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–æ–∑–∂–µ –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "   nohup ./.venv/bin/python3 $MAIN_PYTHON_FILE > server.log 2>&1 &"
fi

echo ""
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"